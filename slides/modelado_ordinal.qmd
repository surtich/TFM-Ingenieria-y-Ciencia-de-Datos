
## Regresión Ordinal


:::: {.columns}
::: {.column width="50%"}

```{r}
#| fig-cap: Comprobación de la proporcionalidad de *odds*.
#| fig-height: 10
po.check <- function(x, responses = 1:3) {
    return(df_response %>% group_by(.data[[x]], Response) %>% count() %>% ungroup(Response) %>% mutate(cum.sum = cumsum(n), log.odds = qlogis(cum.sum / last(cum.sum)), diff.log.odds = log.odds - lead(x = log.odds, n = 1), odds = cum.sum / (last(cum.sum) - cum.sum), ratio.odds = odds / lead(odds)) %>% arrange(Response) %>% filter(Response %in% responses) %>% mutate(Predictor = x) %>% rename_with(~"Value", x))
}


bind_rows(po.check("Item"), po.check("Period"), po.check("Seq"), po.check("Treat")) %>%
    mutate(Response = recode_factor(Response, "1" = "1|2", "2" = "2|3", "3" = "3|4")) %>%
    ggplot(aes(
        x = diff.log.odds, y = Value,
        shape = Predictor, color = Predictor
    )) +
    geom_point(size = 3) +
    facet_grid(
        cols = vars(Response), rows = vars(Predictor), scales = "free_y",
        space = "free", switch = "both"
    ) +
    theme(panel.spacing.y = unit(0.2, "lines"))
```

:::
::: {.column width="50%"}

```{r}
#| tbl-cap: Comprobación de la proporcionalidad de *odds* para Seq.
po.check("Seq", responses = 1:5) %>%
    dplyr::select(c("Response", "n", "cum.sum", "odds", "log.odds", "diff.log.odds")) %>%
    gt() %>%
    fmt_number(columns = c("odds", "log.odds", "log.odds", "diff.log.odds")) %>%
    tab_options(table.font.size = 30)
```
:::
:::


## Regresión Ordinal

```{r}
#| eval: false
#| echo: true
options(contrasts = rep("contr.sum", 2))
clm_sum_treat.period <- clm(
    Response ~ Treat * Period,
    data = df_response, link = "logit"
)

clmm_treat.period.subject.item <- clmm(
    Response ~ Treat * Period + (1 + Treat | Subject) + (1 + Treat | Item),
    data = df_response
)
```


```{r}
clm_sum_treat.period <- readRDS("../models/clm_sum_treat.period.rds")
clmm_treat.period.subject.item <- readRDS("../models/clmm_treat.period.subject.item.rds")

models <- list()
models[[format(clm_sum_treat.period$formula)]] <- clm_sum_treat.period
models[[gsub("\\s+", " ", paste(format(clmm_treat.period.subject.item$formula, trim = T), collapse = ""))]] <- clmm_treat.period.subject.item
modelsummary(models, estimate = "{estimate}{stars}", gof_omit = c("RMSE"), statistic = c("std.error", "conf.int"), metrics = c("AIC", "BIC", "Log.Lik."), shape = term:contrast ~ model + statistic, output = "gt") %>%
    cols_hide(columns = c(2)) %>%
    tab_options(table.font.size = 25)
```


## Regresión Ordinal


![Muestreo de la función predictiva a posteriori por tratamiento e ítem.](../images/bayes-preg.png)
